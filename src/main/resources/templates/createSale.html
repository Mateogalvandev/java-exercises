<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kerubines App - Lista de Usuarios</title>
    <!-- Bootstrap core CSS -->
    <link th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
          rel="stylesheet">
    <!-- Custom styles for this template -->
    <link th:href="@{/css/sb-admin-2.min.css}" rel="stylesheet">
    <!-- DataTables CSS -->
    <link th:href="@{/vendor/datatables/dataTables.bootstrap4.min.css}" rel="stylesheet">
    <!-- Custom styles for buttons and table -->
    <style>
        .action-column {
            width: 120px;
        }
        .btn-circle {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
        }
        .btn-group-sm > .btn-circle {
            width: 25px;
            height: 25px;
            line-height: 25px;
        }
        tr.edit-active {
            background-color: #f8f9fa;
            transform: scale(1.01);
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* Estilo personalizado */
        .container-custom {
            max-width: 95%;
            margin: auto;
            padding: 1rem;
        }

        .card-section {
            margin-bottom: 2rem;
        }

        .form-label {
            font-weight: 500;
        }

        .table-responsive {
            margin-top: 0.5rem;
        }

        .card-section:hover {
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body id="page-top">
<!-- Page Wrapper -->
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/index.html">
            <div class="sidebar-brand-icon">
                <i class="fas fa-home"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Kerubines App</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">Gestion</div>

        <!-- Nav Item - Users -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-user"></i>
                <span>Usuarios</span>
            </a>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Acciones:</h6>
                    <a class="collapse-item" th:href="@{/user/create}">Crear Usuario</a>
                    <a class="collapse-item" th:href="@{/user/list}">Lista de Usuarios</a>
                </div>
            </div>
        </li>

        <!-- Nav Item - Utilities Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
               aria-expanded="true" aria-controls="collapseUtilities">
                <i class="fas fa-money-check-alt"></i>
                <span>Ventas</span>
            </a>
            <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                 data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Acciones:</h6>
                    <a class="collapse-item" href="/sale/create">Crear ventas</a>
                    <a class="collapse-item" href="/sale/list">Lista de ventas</a>
                </div>
            </div>
        </li>
        <!-- Nav Item - Products Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseProducts"
               aria-expanded="true" aria-controls="collapseProducts">
                <i class="fas fa-box"></i>
                <span>Productos</span>
            </a>
            <div id="collapseProducts" class="collapse" aria-labelledby="headingProducts"
                 data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Acciones:</h6>
                    <a class="collapse-item" href="/product/create">Nuevo producto</a>
                    <a class="collapse-item" href="/product/list">Lista de productos</a>
                </div>
            </div>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseCategory"
               aria-expanded="true" aria-controls="collapseCategory">
                <i class="fas fa-box"></i>
                <span>Categorias</span>
            </a>
            <div id="collapseCategory" class="collapse" aria-labelledby="headingProducts"
                 data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Acciones:</h6>
                    <a class="collapse-item" href="/cateogry/create">Nueva categoria</a>
                    <a class="collapse-item" href="/category/list">Lista de categorias</a>
                </div>
            </div>
        </li>

        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
               aria-expanded="true" aria-controls="collapsePages">
                <i class="fas fa-fw fa-folder"></i>
                <span>Proveedores</span>
            </a>
            <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="/suppliers/create">Crear proovedor</a>
                    <a class="collapse-item" href="/suppliers/list">Lista de proovedores</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- Topbar -->
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                <!-- Sidebar Toggle (Topbar) -->
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>

                <!-- Topbar Search -->


                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    <!-- Nav Item - Alerts -->


                    <div class="topbar-divider d-none d-sm-block"></div>

                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small">UsuarioDemo</span>
                            <i class="fas fa-user-circle"></i>
                        </a>
                        <!-- Dropdown - User Information -->
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                             aria-labelledby="userDropdown">
                            <!-- Otras opciones comunes: perfil, ajustes, etc. -->
                            <!-- <a class="dropdown-item" href="#">Perfil</a> -->

                            <!-- Cerrar sesión dentro del menú -->
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                Cerrar sesión
                            </a>
                        </div>

                </ul>

            </nav>
            <!-- End of Topbar -->

            <!-- Begin Page Content -->

            <div class="container-custom">
                <form th:action="@{/sale/create/save}" th:object="${saleCreateATT}" method="POST">

                    <!-- Información del Cliente -->
                    <div class="card shadow mb-4 card-section">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-user"></i> Información del Cliente</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Nombre Completo *</label>
                                    <input type="text" id="name" class="form-control" name="name"
                                           th:field="*{clientName}" placeholder="Ingrese el nombre del cliente"
                                           required/>
                                </div>
                                <div class="col-md-6">
                                    <label for="clientNum" class="form-label">Número de Teléfono</label>
                                    <input type="tel" id="clientNum" class="form-control" name="clientNum"
                                           th:field="*{clientNum}" placeholder="Ej: +54 9 381 123-4567"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div class="card shadow mb-4 card-section">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-box-open"></i> Productos</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Seleccione los productos y cantidades para la venta</p>
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle" id="dataTableProducts" cellspacing="0">
                                    <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unitario</th>
                                        <th>Acción</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>
                                            <select class="form-select form-select-sm" id="productoSeleccionado">
                                                <option value="">Seleccionar producto</option>
                                                <option th:each="producto : ${productos}"
                                                        th:value="${producto.idProduct}"
                                                        th:text="${producto.productName}"
                                                        th:data-talle="${producto.size}"
                                                        th:data-categoria="${producto.category}"
                                                        th:data-precio="${producto.cost}">
                                                </option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" id="cantidad"
                                                   value="1" min="1"/>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" id="precioUnitario"
                                                   value="$0.00" readonly/>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-success btn-sm" onclick="agregarProducto()">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="resumenProductos" class="mt-3"></div>
                            <div id="selected-products-container"></div>
                        </div>
                    </div>

                    <!-- Pago y Notas -->
                    <div class="row card-section">
                        <div class="col-md-6">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-money-check-alt"></i> Pago y Notas</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="metodoPago" class="form-label">Método de Pago *</label>
                                        <select class="form-select" id="metodoPago" th:field="*{typeSale}" required>
                                            <option value="">Seleccionar método de pago</option>
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta de Crédito/Débito</option>
                                            <option value="transferencia">Transferencia Bancaria</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="descuento" class="form-label">Descuento (%)</label>
                                        <input type="number" class="form-control" id="descuento" value="0" min="0"/>
                                    </div>
                                    <div class="mb-3">
                                        <label for="notasAdicionales" class="form-label">Notas Adicionales</label>
                                        <textarea class="form-control" id="notasAdicionales" rows="3"
                                                  placeholder="Comentarios o notas sobre la venta..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de Venta -->
                        <div class="col-md-6">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-receipt"></i> Resumen de la Venta</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="totalVenta" class="form-label">Total:</label>
                                        <input type="text" class="form-control" id="totalVenta" value="$0.00" readonly/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" th:field="*{productListString}" />
                    <input type="hidden" th:field="*{cantidades}" />
                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-end mb-4">
                        <button type="submit" class="btn btn-primary"> Facturar</button>
                    </div>
                </form>
            </div>

        <!-- /.container-fluid -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Mateogalvandev 2025</span>
                </div>
            </div>
        </footer>
        <!-- End of Footer -->
    </div>
    <!-- End of Main Content -->
</div>
<!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button -->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Seguro desea cerrar sesión?</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Una vez cerrada la sesión debera volver a iniciar sesión para hacer uso del software. </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                <a class="btn btn-primary" href="/login?logout">Cerrar sesión</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript -->
<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript -->
<script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Page level plugins -->
<script th:src="@{/vendor/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/vendor/datatables/dataTables.bootstrap4.min.js}"></script>

<!-- Custom scripts -->
<script th:src="@{/js/sb-admin-2.min.js}"></script>

<!-- Initialize DataTable -->
<script>
    $(document).ready(function () {
      $('#dataTable').DataTable({
          "language": {
              "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
          },
          "columnDefs": [
              {
                  "targets": [4],
                  "orderable": false,
                  "searchable": false
              }
          ]
      });
  });

  const selectProducto = document.getElementById('productoSeleccionado');
  const inputCantidad = document.getElementById('cantidad');
  const inputPrecio = document.getElementById('precioUnitario');
  const resumenDiv = document.getElementById('resumenProductos');
  const container = document.getElementById('selected-products-container');
  const totalVentaInput = document.getElementById('totalVenta');

  // Mostrar tooltip con talle y categoría
  new bootstrap.Tooltip(document.getElementById('productoSeleccionado'), {
      title: () => {
          const option = selectProducto.options[selectProducto.selectedIndex];
          return `Talle: ${option.dataset.talle || 'N/A'}, Categoría: ${option.dataset.categoria || 'N/A'}`;
      },
      placement: 'top',
      trigger: 'hover'
  });

  // Actualizar precio cuando cambia el producto
  selectProducto.addEventListener('change', function () {
      const selectedOption = this.options[this.selectedIndex];
      const precio = parseFloat(selectedOption.dataset.precio) || 0;
      inputPrecio.value = `$${precio.toFixed(2)}`;
  });

  let totalVenta = 0;

  // Agregar producto al listado final
  function agregarProducto() {
    const selectProducto = document.getElementById('productoSeleccionado');
    const inputCantidad = document.getElementById('cantidad');
    const productListContainer = document.getElementById('selected-products-container');
    const productListStringInput = document.getElementById('productListString');
    const cantidadesInput = document.getElementById('cantidades');

    const idProducto = selectProducto.value;
    const nombreProducto = selectProducto.options[selectProducto.selectedIndex].text;
    const cantidad = parseInt(inputCantidad.value);
    const precio = parseFloat(selectProducto.options[selectProducto.selectedIndex].dataset.precio) || 0;

    if (!idProducto || isNaN(cantidad) || cantidad <= 0 || precio <= 0) {
        alert("Por favor seleccione un producto válido y una cantidad mayor a cero.");
        return;
    }

    // Verificar si ya fue agregado
    if (document.getElementById(`input-producto-${idProducto}`)) {
        alert("Este producto ya fue agregado.");
        return;
    }

    // Crear elemento visual
    const div = document.createElement('div');
    div.className = 'd-flex justify-content-between mb-2';
    div.innerHTML = `
        <span>${nombreProducto} x${cantidad}</span>
        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">Eliminar</button>
    `;
    productListContainer.appendChild(div);

    // Actualizar campos ocultos
    let ids = JSON.parse(productListStringInput.value || "[]");
    let qts = JSON.parse(cantidadesInput.value || "[]");

    ids.push(idProducto);
    qts.push(cantidad);

    productListStringInput.value = JSON.stringify(ids);
    cantidadesInput.value = JSON.stringify(qts);
}
</script>
</body>
</html>